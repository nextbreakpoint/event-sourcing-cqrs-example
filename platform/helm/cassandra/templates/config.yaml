{{- $fullname := include "service.fullname" . -}}
{{- $name := include "service.name" . -}}
{{- $chart := include "service.chart" . -}}
{{- $root := . }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $root.Values.name | default "cassandra" | quote }}
  namespace: {{ $root.Release.Namespace | quote }}
  labels:
    chart: {{ $chart }}
    release: {{ $root.Release.Name }}
    heritage: {{ $root.Release.Service }}
data:
  init.cql: |
    CREATE ROLE IF NOT EXISTS admin WITH PASSWORD = 'password' AND LOGIN = true;
    CREATE ROLE IF NOT EXISTS verticle WITH PASSWORD = 'password' AND LOGIN = true;

    CREATE KEYSPACE IF NOT EXISTS designs WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 1 };

    GRANT ALL PERMISSIONS on KEYSPACE designs TO admin;
    GRANT ALL PERMISSIONS on KEYSPACE designs TO verticle;

    USE designs;

    CREATE TABLE IF NOT EXISTS DESIGN_EVENT (
      DESIGN_UUID UUID,
      DESIGN_EVID TIMEUUID,
      DESIGN_DATA TEXT,
      DESIGN_CHECKSUM TEXT,
      DESIGN_STATUS TEXT,
      DESIGN_UPDATED TIMESTAMP,
      PRIMARY KEY (DESIGN_UUID, DESIGN_EVID)
    ) WITH CLUSTERING ORDER BY (DESIGN_EVID ASC);

    CREATE TABLE IF NOT EXISTS DESIGN_AGGREGATE (
      DESIGN_UUID UUID,
      DESIGN_EVID TIMEUUID,
      DESIGN_DATA TEXT,
      DESIGN_CHECKSUM TEXT,
      DESIGN_STATUS TEXT,
      DESIGN_UPDATED TIMESTAMP,
      PRIMARY KEY (DESIGN_UUID)
    );

    CREATE KEYSPACE IF NOT EXISTS tiles WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 1 };

    GRANT ALL PERMISSIONS ON KEYSPACE tiles TO admin;
    GRANT ALL PERMISSIONS ON KEYSPACE tiles TO verticle;

    USE tiles;

    CREATE TABLE IF NOT EXISTS TILE_EVENT (
      TILE_DESIGN_UUID UUID,
      TILE_DESIGN_EVID TIMEUUID,
      TILE_DESIGN_DATA TEXT,
      TILE_DESIGN_CHECKSUM TEXT,
      TILE_EVID UUID,
      TILE_LEVEL INT,
      TILE_ROW INT,
      TILE_COL INT,
      TILE_STATUS TEXT,
      TILE_UPDATED TIMESTAMP,
      PRIMARY KEY (TILE_DESIGN_UUID, TILE_DESIGN_EVID, TILE_LEVEL, TILE_ROW, TILE_COL, TILE_EVID)
    ) WITH CLUSTERING ORDER BY (TILE_DESIGN_EVID ASC, TILE_EVID ASC);

    CREATE TABLE IF NOT EXISTS TILE_AGGREGATE (
      TILE_DESIGN_UUID UUID,
      TILE_DESIGN_EVID TIMEUUID,
      TILE_DESIGN_DATA TEXT,
      TILE_DESIGN_CHECKSUM TEXT,
      TILE_EVID UUID,
      TILE_LEVEL INT,
      TILE_ROW INT,
      TILE_COL INT,
      TILE_STATUS TEXT,
      TILE_UPDATED TIMESTAMP,
    PRIMARY KEY (TILE_DESIGN_UUID, TILE_LEVEL, TILE_ROW, TILE_COL)
    );