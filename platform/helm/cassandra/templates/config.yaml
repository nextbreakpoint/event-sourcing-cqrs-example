{{- $fullname := include "service.fullname" . -}}
{{- $name := include "service.name" . -}}
{{- $chart := include "service.chart" . -}}
{{- $root := . }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $root.Values.name | default "cassandra" | quote }}
  namespace: {{ $root.Release.Namespace | quote }}
  labels:
    chart: {{ $chart }}
    release: {{ $root.Release.Name }}
    heritage: {{ $root.Release.Service }}
data:
  init.cql: |
    CREATE KEYSPACE IF NOT EXISTS designs WITH REPLICATION = { 'class' : 'SimpleStrategy', 'replication_factor' : 1 };

    CREATE ROLE IF NOT EXISTS admin WITH PASSWORD = 'password' AND LOGIN = true;
    CREATE ROLE IF NOT EXISTS verticle WITH PASSWORD = 'password' AND LOGIN = true;

    GRANT ALL PERMISSIONS on KEYSPACE designs TO admin;
    GRANT ALL PERMISSIONS on KEYSPACE designs TO verticle;

    USE designs;

    CREATE TABLE IF NOT EXISTS DESIGN_EVENT (
      DESIGN_UUID UUID,
      DESIGN_EVID TIMEUUID,
      DESIGN_DATA TEXT,
      DESIGN_CHECKSUM TEXT,
      DESIGN_STATUS TEXT,
      DESIGN_UPDATED TIMESTAMP,
      PRIMARY KEY (DESIGN_UUID, DESIGN_EVID)
    ) WITH CLUSTERING ORDER BY (DESIGN_EVID ASC);

    CREATE TABLE IF NOT EXISTS DESIGN_AGGREGATE (
      DESIGN_UUID UUID,
      DESIGN_DATA TEXT,
      DESIGN_CHECKSUM TEXT,
      DESIGN_UPDATED TIMESTAMP,
      PRIMARY KEY (DESIGN_UUID)
    );

    CREATE TABLE IF NOT EXISTS DESIGN_VERSION (
      DESIGN_CHECKSUM TEXT,
      DESIGN_DATA TEXT,
      DESIGN_UPDATED TIMESTAMP,
      PRIMARY KEY (DESIGN_CHECKSUM)
    );

    CREATE TABLE IF NOT EXISTS DESIGN_TILE (
      DESIGN_CHECKSUM TEXT,
      TILE_LEVEL SMALLINT,
      TILE_ROW SMALLINT,
      TILE_COL SMALLINT,
      TILE_LOCATION TEXT,
      TILE_STATUS TEXT,
      PRIMARY KEY (DESIGN_CHECKSUM, TILE_LEVEL, TILE_ROW, TILE_COL)
    );

