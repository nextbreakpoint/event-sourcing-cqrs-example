<!DOCTYPE html>
{% set design = context.get('design') %}
<html>
    <head>
        <title>Preview of selected design</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href="/css/materialize.min.css" media="screen,projection"/>
        <link rel="stylesheet" href="/css/leaflet.css" media="screen,projection"/>
        <link rel="stylesheet" href="/css/main.css" media="screen,projection"/>
        <script type="text/javascript" src="/js/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="/js/materialize.min.js"></script>
        <script>
            $(function() {
                function makeDesign(design, modified) {
                    var image = $('<img></img>')
                        .attr('class', 'design-image')
                        .attr('id', design.uuid)
                        .attr('src', '{{context.get('designs_url')}}/api/designs/' + uuid + '/0/0/0/512.png?t=' + modified)
                        .attr('alt', '{{context.get('web_url')}}/content/designs/' + uuid);

                    var script = $('<pre></pre>')
                         .attr('class', 'design-script')
                         .append(design.script);

                    var metadata = $('<pre></pre>')
                         .attr('class', 'design-script')
                         .append(design.metadata);

                    var leftColumn = $('<div></div>')
                         .attr('class', 'col s8')
                         .append(image);

                    var rightColumn = $('<div></div>')
                         .attr('class', 'col s4')
                         .append(script)
                         .append(metadata);

                    return $('<div></div>')
                        .attr('class', 'row')
                        .append(leftColumn)
                        .append(rightColumn)
                }

                function updateDesign(modified, design) {
                    console.log("update design");

                    $('#design').empty();

                    $('#design').append(makeDesign(design, modified));
                }

                if (typeof(EventSource) !== "undefined") {
                    var offset = {{context.get('offset')}};
                    var uuid = "{{design.uuid}}";

                    var source = new EventSource("/watch/" + offset + "/designs/" + uuid, { withCredentials: true });

                    source.addEventListener("message",  function(event) {
                       var json = JSON.parse(event.data);

                       console.log(event);

                       if (json.offset > offset) {
                            offset = json.offset;

                            $.get("{{context.get('designs_url')}}/api/designs/" + uuid, function(data) {
                                console.log(data);
                            }).done(function(data) {
                                updateDesign(offset, data);
                            }).fail(function(e) {
                                console.log(e);
                            });
                       }
                    }, false);

                    source.onerror = function(error) {
                       console.log(error);
                    };

                    source.onmessage = function(message) {
                    };
                } else {
                    console.log("EventSource not available");
                }
            })
        </script>
    </head>
    <body>
        <input type="hidden" id="modified" value="{{context.get('modified')}}"/>
        <input type="hidden" id="offset" value="{{context.get('offset')}}"/>
        <div class="container s12">
            <div class="row">
                <div class="col s12">
                    <header>
                        <div class="row">
                            <div class="col s6">
                                <span class="float-left">Welcome {{context.get('username')}}</span>
                            </div>
                            <div class="col s6 right-align">
                                <span class="float-right">{% if context.get('role') == 'admin' %}<a href="{{context.get('admin_url')}}">Admin</a> | {% endif %}<a href="/content/designs">Designs</a> | {% if context.get('logged') %}<a href="{{context.get('logout_url') + "/" + design.uuid}}">Logout</a>{% else %}<a href="{{context.get('login_url') + "/" + design.uuid}}">Login</a>{% endif %}</span>
                            </div>
                        </div>
                    </header>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <section id="design" class="design-container anchor-left anchor-right">
                        <div class="row">
                            <div class="col s8">
                                <img class="design-image" id="{{design.uuid}}" src="{{design.imageSrc}}?t={{context.get('modified')}}" alt="{{design.location}}"/>
                            </div>
                            <div class="col s4">
                                <pre class="design-script">{{design.script}}</pre>
                                <pre class="design-script">{{design.metadata}}</pre>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <footer>
                        <span>Powered by NextBreakpoint</span>
                    </footer>
                </div>
            </div>
        </div>
    </body>
</html>
