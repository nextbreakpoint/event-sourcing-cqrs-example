<!DOCTYPE html>
<html>
    <head>
        <title>List of published designs</title>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
        <link rel="stylesheet" href="/css/materialize.min.css" media="screen,projection"/>
        <link rel="stylesheet" href="/css/main.css" media="screen,projection"/>
        <script type="text/javascript" src="/js/jquery-3.1.1.min.js"></script>
        <script type="text/javascript" src="/js/materialize.min.js"></script>
        <script>
            $(function() {
                function makeDesign(uuid, modified) {
                    var image = $('<img></img>')
                        .attr('class', 'designs-grid-element-image')
                        .attr('id', uuid)
                        .attr('src', '{{context.get('designs_url')}}/api/designs/' + uuid + '/0/0/0/256.png?t=' + modified)
                        .attr('alt', '{{context.get('web_url')}}/content/designs/' + uuid);

                    var anchor = $('<a></a>')
                         .attr('href', '{{context.get('web_url')}}/content/designs/' + uuid)
                         .append(image);

                    return $('<div></div>')
                        .attr('class', 'designs-grid-element')
                        .append(anchor)
                }

                function updateDesigns(modified, designs) {
                    console.log("update designs");

                    $('#designs').empty();

                    $(designs).each(function(index, uuid) {
                        $('#designs').append(makeDesign(uuid, modified));
                    })
                }

                if (typeof(EventSource) !== "undefined") {
                    var offset = {{context.get('offset')}};

                    var source = new EventSource("/watch/" + offset + "/designs", { withCredentials: true });

                    source.addEventListener("message",  function(event) {
                       var json = JSON.parse(event.data);

                       console.log(event);

                       if (json.offset > offset) {
                            offset = json.offset;

                            $.get("{{context.get('designs_url')}}/api/designs", function(data) {
                                console.log(data);
                            }).done(function(data) {
                                updateDesigns(offset, data);
                            }).fail(function(e) {
                                console.log(e);
                            });
                       }
                    }, false);

                    source.onerror = function(error) {
                       console.log(error);
                    };

                    source.onmessage = function(message) {
                    };
                } else {
                    console.log("EventSource not available");
                }
            })
        </script>
    </head>
    <body>
        <input type="hidden" id="modified" value="{{context.get('modified')}}"/>
        <input type="hidden" id="offset" value="{{context.get('offset')}}"/>
        <div class="container s12">
            <div class="row">
                <div class="col s12">
                    <header>
                        <div class="row">
                            <div class="col s6">
                                <span class="float-left">Welcome {{context.get('username')}}</span>
                            </div>
                            <div class="col s6 right-align">
                                <span class="float-right">{% if context.get('role') == 'admin' %}<a href="{{context.get('admin_url')}}">Admin</a> | {% endif %}{% if context.get('logged') %}<a href="{{context.get('logout_url')}}">Logout</a>{% else %}<a href="{{context.get('login_url')}}">Login</a>{% endif %}</span>
                            </div>
                        </div>
                    </header>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <section id="designs" class="designs-grid-container anchor-left anchor-right">
                    {% for design in context.get('designs') %}
                        <div class="designs-grid-element">
                            <a href="{{design.location}}"><img class="designs-grid-element-image" id="{{design.uuid}}" src="{{design.imageSrc}}?t={{context.get('modified')}}" alt="{{design.location}}"/></a>
                        </div>
                    {% endfor %}
                    </section>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <footer>
                        <span>Powered by NextBreakpoint</span>
                    </footer>
                </div>
            </div>
        <div>
    </body>
</html>
